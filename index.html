<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Starfarer v3.3 | System Integrated</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* DEFAULT: SCARLET GUARD */
            --bg-armor: #0a0a0a;
            --bg-screen: #000000;
            --bg-panel: #151515;
            --color-primary: #d32f2f; /* Scarlet */
            --color-secondary: #546e7a; /* Steel */
            --color-text: #666;
            --color-active: #00e676;
            --color-alert: #ff5252;
            --color-data: #4fc3f7;
            
            --font-head: 'Black Ops One', cursive;
            --font-data: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #000;
            color: var(--color-primary);
            font-family: var(--font-data);
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: color 0.3s, background-color 0.3s;
        }

        /* --- THE CHASSIS --- */
        .padd-casing {
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--bg-armor);
            border-left: 3px solid #222; border-right: 3px solid #222;
            transition: background 0.3s;
        }

        /* --- HEADER --- */
        .top-plate {
            flex: 0 0 55px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            background: var(--bg-panel);
            border-bottom: 2px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .brand {
            font-family: var(--font-head); font-size: 1.3rem;
            color: var(--color-text); text-shadow: -1px -1px 0 #000;
            letter-spacing: 1px;
        }
        .theme-btn {
            background: #222; border: 1px solid #444; color: var(--color-secondary);
            font-size: 0.7rem; padding: 4px 8px; cursor: pointer; border-radius: 4px;
            font-weight: bold; font-family: var(--font-data);
        }

        /* --- MODE ROCKER --- */
        .mode-plate {
            flex: 0 0 45px;
            background: var(--bg-armor); border-bottom: 1px solid #333;
            display: flex; padding: 4px;
        }
        .rocker-switch {
            width: 100%; display: flex; background: #000;
            border: 1px solid #333; border-radius: 4px;
        }
        .rocker-btn {
            flex: 1; border: none; cursor: pointer;
            font-family: var(--font-head); font-size: 0.8rem;
            text-transform: uppercase; background: #222; color: #444;
            transition: all 0.2s;
        }
        .rocker-btn.active-data { background: var(--color-data); color: #000; }
        .rocker-btn.active-music { background: var(--color-primary); color: #000; }

        /* --- MAIN SCREEN --- */
        .screen-viewport {
            flex: 1 1 auto;
            background: var(--bg-screen);
            margin: 8px; border: 2px solid #333; border-radius: 6px;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            transition: background 0.3s;
        }

        /* --- VISUALIZER --- */
        .vis-container {
            flex: 0 0 80px; width: 100%;
            border-bottom: 1px solid #222; background: rgba(0,0,0,0.2);
            position: relative; cursor: pointer;
        }
        canvas { width: 100%; height: 100%; display: block; }
        .vis-label {
            position: absolute; top: 2px; right: 4px;
            font-size: 0.6rem; color: #444; pointer-events: none;
        }

        /* --- READOUT --- */
        .readout-panel { padding: 10px; text-align: center; border-bottom: 1px solid #222; }
        .track-name { 
            font-size: 1rem; color: var(--color-primary); 
            text-transform: uppercase; margin-bottom: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .track-time { color: var(--color-secondary); font-size: 0.9rem; }

        /* --- DATA STREAM --- */
        .data-stream { flex: 1; overflow-y: auto; padding: 4px; }
        .data-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 8px; border-bottom: 1px solid #222;
            color: var(--color-text); font-size: 0.85rem;
        }
        .data-row.active { 
            background: rgba(100, 100, 100, 0.1); 
            color: var(--color-primary); 
            border-left: 3px solid var(--color-primary); 
        }
        .btn-del { background: transparent; border: 1px solid #333; color: var(--color-secondary); padding: 2px 6px; }

        /* --- CONTROL DECK --- */
        .control-deck {
            flex: 0 0 auto;
            background: var(--bg-panel); padding: 10px;
            border-top: 2px solid #333;
            display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 20px;
            transition: background 0.3s;
        }

        /* BUTTONS */
        .tac-row {
            display: flex; justify-content: space-between; gap: 5px;
            background: rgba(0,0,0,0.2); padding: 6px; border: 1px solid #333; border-radius: 4px;
        }
        .tac-btn {
            background: #222; border: 1px solid #333; color: #555;
            font-size: 0.65rem; padding: 8px 0; flex: 1; text-align: center;
            border-radius: 2px; cursor: pointer; font-weight: bold;
        }
        .tac-btn.on { background: rgba(255,255,255,0.1); color: var(--color-primary); border-color: var(--color-primary); }
        .tac-btn.warp.on { color: var(--color-active); border-color: var(--color-active); }

        .transport-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 8px; }
        .jump-btn {
            background: #222; border: 1px solid #333; color: var(--color-secondary);
            font-size: 0.8rem; border-radius: 4px;
        }
        .play-btn {
            background: #222; border: 1px solid #444; color: #888;
            font-family: var(--font-head); font-size: 1rem;
            padding: 12px 0; border-radius: 4px; letter-spacing: 1px;
        }
        .play-btn.active { color: var(--color-active); border-color: var(--color-active); text-shadow: 0 0 8px var(--color-active); }

        .util-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
        .util-btn {
            background: #111; border: 1px solid #333; color: #666;
            font-size: 0.7rem; padding: 8px 0; cursor: pointer;
        }
        .util-btn.speed { color: var(--color-data); }
        .util-btn.purge { color: var(--color-alert); }

        #resumeBanner {
            display: none; background: var(--color-data); color: #000;
            text-align: center; padding: 6px; font-weight: bold;
            font-family: var(--font-head); font-size: 0.8rem; cursor: pointer;
        }

        audio { display: none; }

    </style>
</head>
<body>

<div class="padd-casing">
    
    <div class="top-plate">
        <div class="brand">STARFARER v3.3</div>
        <button class="theme-btn" onclick="cycleTheme()">[ THEME ]</button>
    </div>

    <div class="mode-plate">
        <div class="rocker-switch">
            <button class="rocker-btn active-data" id="modeData" onclick="setMode('data')">DATA</button>
            <button class="rocker-btn" id="modeMusic" onclick="setMode('music')">MUSIC</button>
        </div>
    </div>

    <div class="screen-viewport">
        <div class="vis-container" onclick="cycleVisMode()">
            <canvas id="visCanvas"></canvas>
            <div class="vis-label" id="visLabel">SPEC-A</div>
        </div>

        <div id="resumeBanner" onclick="resumePlayback()">>> LOG FOUND: RESUME <<</div>

        <div class="readout-panel">
            <div class="track-name" id="nowPlaying">SYSTEM STANDBY</div>
            <div class="track-time" id="timeDisplay">00:00</div>
        </div>

        <div class="data-stream" id="playlist"></div>
    </div>

    <div class="control-deck">
        <div class="tac-row">
            <div class="tac-btn" id="btnBass" onclick="toggleBass()">HULL (BASS)</div>
            <div class="tac-btn" id="btnVoc" onclick="toggleVocal()">COMMS (VOC)</div>
            <div class="tac-btn" id="btnLevel" onclick="toggleLeveler()">LEVELER</div>
            <div class="tac-btn warp" id="btnWarp" onclick="toggleWarp()">WARP CORE</div>
        </div>

        <div class="transport-row">
            <button class="jump-btn" onclick="jump(-15)">&#60;&#60; 15s</button>
            <button class="play-btn" id="btnPlay" onclick="togglePlay()">ENGAGE</button>
            <button class="jump-btn" onclick="jump(30)">30s &#62;&#62;</button>
        </div>

        <div class="util-row">
            <button class="util-btn" onclick="document.getElementById('fileInput').click()">LOAD</button>
            <button class="util-btn speed" id="btnSpeed" onclick="cycleSpeed()">1.0x</button>
            <button class="util-btn" id="btnShuffle" onclick="toggleShuffle()">SHUF: OFF</button>
            <button class="util-btn purge" onclick="nukeVault()">PURGE</button>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="audio/*" style="display:none" onchange="handleUpload(this.files)">
    <audio id="audioPlayer" crossorigin="anonymous"></audio>

</div>

<script>
    /* --- CONFIG --- */
    const DB_NAME = 'StarfarerOmega';
    const STORE_NAME = 'cargo';
    const BOOKMARK_KEY = 'omega_bookmark';
    const THEME_KEY = 'omega_theme';
    
    let db, audio = document.getElementById('audioPlayer');
    let playlistData = [], currentIndex = -1;
    let currentMode = 'data'; 
    let isShuffle = false;
    let playbackRate = 1.0;

    // AUDIO GRAPH
    let audioCtx, source, bassFilter, vocalFilter, compressor, analyser, canvas, ctx;
    let isAudioInit = false;
    let warpNode, warpGain, warpFilter, isWarpActive = false;
    let visMode = 0;

    /* --- THEMES --- */
    const THEMES = [
        { name: "SCARLET", primary: "#d32f2f", secondary: "#546e7a", bg: "#0a0a0a", screen: "#000000", text: "#666" },
        { name: "DAY OPS", primary: "#c62828", secondary: "#37474f", bg: "#e0e0e0", screen: "#f5f5f5", text: "#222" },
        { name: "CRYO", primary: "#00bcd4", secondary: "#455a64", bg: "#000a12", screen: "#00101a", text: "#90a4ae" },
        { name: "NIGHT", primary: "#00e676", secondary: "#1b5e20", bg: "#000000", screen: "#050505", text: "#1b5e20" }
    ];
    let themeIndex = 0;

    /* --- INIT --- */
    window.onload = function() {
        initDB();
        loadTheme();
        
        audio.ontimeupdate = () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if(currentIndex >= 0 && currentMode === 'data') saveBookmark();
        };
        audio.onended = () => playNext();

        // System Media Controls setup
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
            navigator.mediaSession.setActionHandler('previoustrack', () => jump(-15)); // Map Prev to Rewind for books
            navigator.mediaSession.setActionHandler('nexttrack', playNext);
            navigator.mediaSession.setActionHandler('seekbackward', () => jump(-15));
            navigator.mediaSession.setActionHandler('seekforward', () => jump(30));
        }
    };

    function initDB() {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
            db = e.target.result;
            if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        };
        req.onsuccess = (e) => { db = e.target.result; scanFiles(); };
    }

    /* --- THEME LOGIC --- */
    function cycleTheme() {
        themeIndex = (themeIndex + 1) % THEMES.length;
        applyTheme(THEMES[themeIndex]);
        localStorage.setItem(THEME_KEY, themeIndex);
    }

    function loadTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved !== null) {
            themeIndex = parseInt(saved);
            applyTheme(THEMES[themeIndex]);
        }
    }

    function applyTheme(t) {
        const r = document.documentElement.style;
        r.setProperty('--color-primary', t.primary);
        r.setProperty('--color-secondary', t.secondary);
        r.setProperty('--bg-armor', t.bg);
        r.setProperty('--bg-screen', t.screen);
        r.setProperty('--color-text', t.text);
        
        // Mode Button Refresh
        const btnData = document.getElementById('modeData');
        const btnMusic = document.getElementById('modeMusic');
        if(currentMode === 'data') btnData.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-data');
        else btnMusic.style.backgroundColor = t.primary;
    }

    /* --- AUDIO ENGINE --- */
    function initAudioEngine() {
        if (isAudioInit) return;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            source = audioCtx.createMediaElementSource(audio);

            bassFilter = audioCtx.createBiquadFilter();
            bassFilter.type = "lowshelf"; bassFilter.frequency.value = 100; bassFilter.gain.value = 0;

            vocalFilter = audioCtx.createBiquadFilter();
            vocalFilter.type = "peaking"; vocalFilter.frequency.value = 3000; vocalFilter.Q.value = 1; vocalFilter.gain.value = 0;

            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.value = 0; compressor.ratio.value = 1;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 128;

            source.connect(bassFilter);
            bassFilter.connect(vocalFilter);
            vocalFilter.connect(compressor);
            compressor.connect(analyser);
            analyser.connect(audioCtx.destination);

            canvas = document.getElementById('visCanvas');
            ctx = canvas.getContext('2d');
            drawVis();
            
            isAudioInit = true;
        } catch(e) { console.log("Audio Init Failed"); }
    }

    /* --- TOGGLES --- */
    function toggleBass() {
        if(!isAudioInit) initAudioEngine();
        const isOn = document.getElementById('btnBass').classList.toggle('on');
        bassFilter.gain.setTargetAtTime(isOn ? 15 : 0, audioCtx.currentTime, 0.1);
    }
    function toggleVocal() {
        if(!isAudioInit) initAudioEngine();
        const isOn = document.getElementById('btnVoc').classList.toggle('on');
        vocalFilter.gain.setTargetAtTime(isOn ? 10 : 0, audioCtx.currentTime, 0.1);
    }
    function toggleLeveler() {
        if(!isAudioInit) initAudioEngine();
        const isOn = document.getElementById('btnLevel').classList.toggle('on');
        compressor.threshold.value = isOn ? -24 : 0;
        compressor.ratio.value = isOn ? 12 : 1;
    }

    function toggleWarp() {
        if(!isAudioInit) initAudioEngine();
        isWarpActive = !isWarpActive;
        const btn = document.getElementById('btnWarp');
        
        if (isWarpActive) {
            btn.classList.add('on');
            const bufferSize = audioCtx.sampleRate * 2; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            warpNode = audioCtx.createBufferSource();
            warpNode.buffer = buffer;
            warpNode.loop = true;

            warpFilter = audioCtx.createBiquadFilter();
            warpFilter.type = 'lowpass'; warpFilter.frequency.value = 120;

            warpGain = audioCtx.createGain();
            warpGain.gain.value = 0.15;

            warpNode.connect(warpFilter);
            warpFilter.connect(warpGain);
            warpGain.connect(audioCtx.destination);
            warpNode.start();
        } else {
            btn.classList.remove('on');
            if(warpNode) warpNode.stop();
        }
    }

    function cycleSpeed() {
        const rates = [1.0, 1.25, 1.5, 0.8];
        let idx = rates.indexOf(playbackRate);
        idx = (idx + 1) % rates.length;
        playbackRate = rates[idx];
        audio.playbackRate = playbackRate;
        audio.preservesPitch = true;
        document.getElementById('btnSpeed').innerText = playbackRate + "x";
    }

    function jump(seconds) { audio.currentTime += seconds; }

    function cycleVisMode() {
        visMode = (visMode + 1) % 3;
        const labels = ["SPEC-A", "SCOPE", "RADAR"];
        document.getElementById('visLabel').innerText = labels[visMode];
    }

    function drawVis() {
        requestAnimationFrame(drawVis);
        const w = canvas.parentElement.clientWidth;
        const h = canvas.parentElement.clientHeight;
        canvas.width = w; canvas.height = h;
        
        // Background color logic based on theme
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-screen');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        const primary = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
        const active = getComputedStyle(document.documentElement).getPropertyValue('--color-active');

        if (visMode === 0) { 
            const len = analyser.frequencyBinCount;
            const data = new Uint8Array(len);
            analyser.getByteFrequencyData(data);
            const barW = (w / len) * 2.5;
            let x = 0;
            for(let i=0; i<len; i++) {
                const barH = (data[i]/255) * h;
                ctx.fillStyle = barH > h*0.7 ? active : primary;
                ctx.fillRect(x, h-barH, barW-1, barH);
                x += barW;
            }
        } else if (visMode === 1) { 
            const len = analyser.fftSize;
            const data = new Uint8Array(len);
            analyser.getByteTimeDomainData(data);
            ctx.lineWidth = 2;
            ctx.strokeStyle = active;
            ctx.beginPath();
            const sliceW = w * 1.0 / len;
            let x = 0;
            for(let i=0; i<len; i++) {
                const v = data[i] / 128.0;
                const y = v * h/2;
                if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceW;
            }
            ctx.stroke();
        } else {
            const len = analyser.frequencyBinCount;
            const data = new Uint8Array(len);
            analyser.getByteFrequencyData(data);
            const avg = data.reduce((a,b)=>a+b,0) / len;
            const r = (avg/255) * (h/2);
            ctx.beginPath();
            ctx.arc(w/2, h/2, r, 0, 2*Math.PI);
            ctx.strokeStyle = primary; ctx.lineWidth = 3; ctx.stroke();
        }
    }

    /* --- CORE LOGIC --- */
    function setMode(mode) {
        currentMode = mode;
        const btnData = document.getElementById('modeData');
        const btnMusic = document.getElementById('modeMusic');
        const banner = document.getElementById('resumeBanner');
        
        btnData.className = mode === 'data' ? 'rocker-btn active-data' : 'rocker-btn';
        btnMusic.className = mode === 'music' ? 'rocker-btn active-music' : 'rocker-btn';
        
        if (mode === 'data') checkBookmark();
        else banner.style.display = 'none';
    }

    function togglePlay() {
        if(!isAudioInit) initAudioEngine();
        if(audio.paused) {
            if(currentIndex === -1 && playlistData.length > 0) loadTrack(0);
            else audio.play();
            document.getElementById('btnPlay').innerText = "HALT";
            document.getElementById('btnPlay').classList.add('active');
        } else {
            audio.pause();
            document.getElementById('btnPlay').innerText = "ENGAGE";
            document.getElementById('btnPlay').classList.remove('active');
        }
        updateMediaSession();
    }

    function loadTrack(index) {
        if(!isAudioInit) initAudioEngine();
        if(index < 0 || index >= playlistData.length) return;
        currentIndex = index;
        const track = playlistData[index];
        audio.src = URL.createObjectURL(track.data);
        audio.playbackRate = playbackRate;
        document.getElementById('nowPlaying').innerText = track.name;
        audio.play();
        document.getElementById('btnPlay').innerText = "HALT";
        document.getElementById('btnPlay').classList.add('active');
        renderList();
        if(audioCtx.state === 'suspended') audioCtx.resume();
        updateMediaSession();
    }

    function playNext() {
        if (currentMode === 'music' && isShuffle) {
            loadTrack(Math.floor(Math.random() * playlistData.length));
        } else if (currentIndex + 1 < playlistData.length) {
            loadTrack(currentIndex + 1);
        } else {
            document.getElementById('nowPlaying').innerText = "END OF DATA";
            document.getElementById('btnPlay').classList.remove('active');
        }
    }

    function toggleShuffle() {
        isShuffle = !isShuffle;
        const btn = document.getElementById('btnShuffle');
        btn.innerText = isShuffle ? "SHUF: ON" : "SHUF: OFF";
        btn.style.color = isShuffle ? "var(--color-active)" : "#666";
    }

    /* --- SYSTEM INTEGRATION (LOCK SCREEN) --- */
    function updateMediaSession() {
        if ('mediaSession' in navigator && currentIndex >= 0) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: playlistData[currentIndex].name,
                artist: "STARFARER PADD",
                album: currentMode === 'data' ? "Data Log" : "Music Mode"
            });
        }
    }

    /* --- DATA HANDLING --- */
    function handleUpload(files) {
        const tx = db.transaction([STORE_NAME], 'readwrite');
        Array.from(files).forEach(f => tx.objectStore(STORE_NAME).add({ name: f.name, data: f }));
        tx.oncomplete = () => scanFiles();
    }

    function scanFiles() {
        playlistData = [];
        const store = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME);
        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                playlistData.push({ ...cursor.value, key: cursor.key });
                cursor.continue();
            } else {
                playlistData.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                renderList();
                if(currentMode==='data') checkBookmark();
            }
        };
    }

    function renderList() {
        const list = document.getElementById('playlist');
        list.innerHTML = '';
        playlistData.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = `data-row ${i === currentIndex ? 'active' : ''}`;
            div.innerHTML = `
                <span onclick="loadTrack(${i})" style="flex-grow:1; overflow:hidden; text-overflow:ellipsis;">${t.name}</span>
                <button class="btn-del" onclick="nukeOne(${t.key})">X</button>
            `;
            list.appendChild(div);
        });
    }

    function nukeOne(key) {
        if(confirm("Purge?")) db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(key).onsuccess = scanFiles;
    }
    
    function nukeVault() {
        if(confirm("WIPE ALL MEMORY?")) db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).clear().onsuccess = () => { localStorage.removeItem(BOOKMARK_KEY); scanFiles(); };
    }

    function saveBookmark() {
        localStorage.setItem(BOOKMARK_KEY, JSON.stringify({ name: playlistData[currentIndex].name, time: audio.currentTime }));
    }

    function checkBookmark() {
        const mark = JSON.parse(localStorage.getItem(BOOKMARK_KEY));
        const banner = document.getElementById('resumeBanner');
        if (mark && playlistData.some(t => t.name === mark.name)) {
            banner.style.display = 'block';
            banner.innerText = `>> RESUME: ${mark.name.substring(0,20)}... <<`;
        } else banner.style.display = 'none';
    }

    function resumePlayback() {
        const mark = JSON.parse(localStorage.getItem(BOOKMARK_KEY));
        const idx = playlistData.findIndex(t => t.name === mark.name);
        if (idx !== -1) {
            document.getElementById('resumeBanner').style.display = 'none';
            loadTrack(idx);
            audio.onloadedmetadata = () => { audio.currentTime = mark.time; };
        }
    }

</script>
</body>
</html>
