<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Starfarer v3.6 | Tri-Corder</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* SCARLET GUARD PALETTE */
            --bg-armor: #0a0a0a;
            --bg-screen: #000000;
            --bg-panel: #151515;
            --color-primary: #d32f2f; /* Scarlet */
            --color-secondary: #78909c; /* Steel */
            --color-text: #999;
            --color-active: #00e676; /* Green Light */
            --color-alert: #ff5252;
            --color-data: #4fc3f7; /* Blue for Logs */
            --color-textmode: #ffb300; /* Amber for Text Reader */
            
            --font-head: 'Black Ops One', cursive;
            --font-data: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #000;
            color: var(--color-primary);
            font-family: var(--font-data);
            margin: 0; padding: 0;
            height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: color 0.3s;
        }

        /* --- CHASSIS --- */
        .padd-casing {
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 600px;
            margin: 0 auto;
            background: var(--bg-armor);
            border-left: 3px solid #333; border-right: 3px solid #333;
        }

        /* --- HEADER --- */
        .top-plate {
            flex: 0 0 55px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            background: var(--bg-panel);
            border-bottom: 2px solid #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .mission-clock {
            font-size: 1.1rem; color: var(--color-active);
            background: #000; padding: 4px 8px; border-radius: 4px; border: 1px solid #333;
        }
        .brand { font-family: var(--font-head); font-size: 1.2rem; color: #aaa; letter-spacing: 1px; }
        .theme-btn {
            background: #222; border: 1px solid #555; color: #ccc;
            font-size: 0.7rem; padding: 6px 10px; cursor: pointer; border-radius: 4px;
        }

        /* --- TRI-CORDER TABS --- */
        .tab-plate {
            flex: 0 0 50px;
            background: var(--bg-armor); border-bottom: 1px solid #333;
            display: flex; padding: 4px; gap: 4px;
        }
        .tab-btn {
            flex: 1; border: none; cursor: pointer;
            font-family: var(--font-head); font-size: 0.85rem;
            text-transform: uppercase; background: #1a1a1a; color: #555;
            transition: all 0.2s; border: 1px solid #333; border-radius: 4px;
        }
        .tab-btn.active { 
            background: #000; border-color: currentColor;
            text-shadow: 0 0 10px currentColor; color: var(--color-primary);
        }
        /* Tab Specific Colors */
        .tab-btn[data-mode="logs"].active { color: var(--color-data); border-color: var(--color-data); }
        .tab-btn[data-mode="music"].active { color: var(--color-primary); border-color: var(--color-primary); }
        .tab-btn[data-mode="text"].active { color: var(--color-textmode); border-color: var(--color-textmode); }
        .tab-btn[data-mode="radio"].active { color: var(--color-alert); border-color: var(--color-alert); }

        /* --- MAIN SCREEN --- */
        .screen-viewport {
            flex: 1 1 auto;
            background: var(--bg-screen);
            margin: 8px; border: 2px solid #444; border-radius: 6px;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        /* VIEW: AUDIO (Logs, Music, Radio) */
        .view-audio { display: flex; flex-direction: column; height: 100%; }
        
        /* VIEW: TEXT READER */
        .view-text { 
            display: none; flex-direction: column; height: 100%; 
            padding: 10px; font-family: 'Share Tech Mono', monospace;
        }
        .text-terminal {
            flex-grow: 1; background: #050505; color: var(--color-textmode);
            border: 1px dashed #333; padding: 15px;
            overflow-y: auto; font-size: 1rem; line-height: 1.6;
            white-space: pre-wrap;
        }

        /* --- VISUALIZER --- */
        .vis-container {
            flex: 0 0 70px; width: 100%;
            border-bottom: 1px solid #333; background: rgba(0,0,0,0.2);
            position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- READOUT --- */
        .readout-panel { padding: 8px; text-align: center; border-bottom: 1px solid #333; }
        .track-name { 
            font-size: 1rem; color: currentColor; 
            text-transform: uppercase; margin-bottom: 4px; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .track-time { color: var(--color-secondary); font-size: 0.8rem; }

        /* --- DATA STREAM --- */
        .data-stream { flex: 1; overflow-y: auto; padding: 4px; }
        .data-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 8px; border-bottom: 1px solid #1a1a1a;
            color: #777; font-size: 0.85rem;
        }
        .data-row.active { 
            background: rgba(100, 100, 100, 0.15); 
            color: currentColor; font-weight: bold;
            border-left: 3px solid currentColor; 
        }
        .btn-del { background: transparent; border: 1px solid #444; color: var(--color-secondary); padding: 4px 8px; }

        /* --- CONTROL DECK --- */
        .control-deck {
            flex: 0 0 auto;
            background: var(--bg-panel); padding: 10px;
            border-top: 2px solid #444;
            display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 25px; /* Thumb Safety */
        }

        /* TACTICAL SWITCH ROW */
        .tac-row {
            display: flex; justify-content: space-between; gap: 5px;
            background: rgba(0,0,0,0.2); padding: 6px; border: 1px solid #333; border-radius: 4px;
        }
        .tac-btn {
            background: #222; border: 1px solid #555; color: #999;
            font-size: 0.6rem; padding: 10px 0; flex: 1; text-align: center;
            border-radius: 2px; cursor: pointer; font-weight: bold;
        }
        .tac-btn.on { background: #111; color: currentColor; border-color: currentColor; box-shadow: 0 0 5px currentColor; }
        .tac-btn.warp.on { color: var(--color-active); border-color: var(--color-active); }

        /* TRANSPORT ROW (Morphing) */
        .transport-row { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 8px; }
        .play-btn {
            background: #2a2a2a; border: 1px solid #666; color: #ddd;
            font-family: var(--font-head); font-size: 1.1rem;
            padding: 12px 0; border-radius: 4px; letter-spacing: 1px;
        }
        .play-btn.active { 
            color: var(--color-active); border-color: var(--color-active); 
            text-shadow: 0 0 8px var(--color-active);
        }
        .jump-btn {
            background: #222; border: 1px solid #555; color: #ccc;
            font-size: 0.8rem; border-radius: 4px;
        }

        /* UTILITY ROW */
        .util-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; }
        .util-btn {
            background: #151515; border: 1px solid #444; color: #888;
            font-size: 0.7rem; padding: 10px 0; cursor: pointer;
        }
        .util-btn.purge { color: var(--color-alert); border-color: rgba(255, 82, 82, 0.3); }

        #resumeBanner {
            display: none; background: var(--color-data); color: #000;
            text-align: center; padding: 6px; font-weight: bold;
            font-family: var(--font-head); font-size: 0.8rem; cursor: pointer;
        }

        audio { display: none; }

    </style>
</head>
<body>

<div class="padd-casing">
    
    <div class="top-plate">
        <div class="mission-clock" id="missionClock">00:00:00</div>
        <div class="brand">STARFARER v3.6</div>
        <button class="theme-btn" onclick="cycleTheme()">[ THEME ]</button>
    </div>

    <div class="tab-plate">
        <button class="tab-btn active" data-mode="logs" onclick="setTab('logs')">LOGS</button>
        <button class="tab-btn" data-mode="music" onclick="setTab('music')">MUSIC</button>
        <button class="tab-btn" data-mode="radio" onclick="setTab('radio')">RADIO</button>
        <button class="tab-btn" data-mode="text" onclick="setTab('text')">TEXT</button>
    </div>

    <div class="screen-viewport">
        
        <div id="viewAudio" class="view-audio">
            <div class="vis-container">
                <canvas id="visCanvas"></canvas>
            </div>
            <div id="resumeBanner" onclick="resumePlayback()">>> RESUME LOG <<</div>
            
            <div class="readout-panel">
                <div class="track-name" id="nowPlaying">SYSTEM IDLE</div>
                <div class="track-time" id="timeDisplay">00:00</div>
            </div>
            
            <div class="data-stream" id="playlist"></div>
        </div>

        <div id="viewText" class="view-text">
            <div style="font-size:0.8rem; color:var(--color-secondary); margin-bottom:5px;">TERMINAL OUTPUT:</div>
            <div class="text-terminal" id="textOutput">NO DATA LOADED...</div>
        </div>

    </div>

    <div class="control-deck">
        
        <div class="tac-row">
            <div class="tac-btn" id="btnTac1" onclick="tac1Action()">HULL</div>
            <div class="tac-btn" id="btnTac2" onclick="tac2Action()">COMMS</div>
            <div class="tac-btn" id="btnTac3" onclick="tac3Action()">LEVEL</div>
            <div class="tac-btn warp" id="btnWarp" onclick="toggleWarp()">WARP</div>
        </div>

        <div class="transport-row">
            <button class="jump-btn" id="btnLeft" onclick="leftAction()">&#60;&#60;</button>
            <button class="play-btn" id="btnCenter" onclick="centerAction()">ENGAGE</button>
            <button class="jump-btn" id="btnRight" onclick="rightAction()">&#62;&#62;</button>
        </div>

        <div class="util-row">
            <button class="util-btn" onclick="triggerLoad()">LOAD</button>
            <button class="util-btn" id="btnUtil1" onclick="util1Action()">SPD:1.0</button>
            <button class="util-btn" id="btnUtil2" onclick="util2Action()">VOICE</button>
            <button class="util-btn purge" onclick="nukeVault()">PURGE</button>
        </div>
    </div>

    <input type="file" id="fileAudio" multiple accept="audio/*" style="display:none" onchange="handleAudioUpload(this.files)">
    <input type="file" id="fileText" accept=".txt,.md,.html" style="display:none" onchange="handleTextUpload(this.files)">
    <audio id="audioPlayer" crossorigin="anonymous"></audio>

</div>

<script>
    /* --- CONFIG --- */
    const DB_NAME = 'StarfarerOmega';
    const STORE_NAME = 'cargo';
    const BOOKMARK_KEY = 'omega_bookmark';
    const THEME_KEY = 'omega_theme';
    
    let db, audio = document.getElementById('audioPlayer');
    let playlistData = [], currentIndex = -1;
    let activeTab = 'logs'; // 'logs', 'music', 'radio', 'text'
    
    // Audio State
    let isShuffle = false, playbackRate = 1.0;
    
    // Text State
    let textContent = "";
    let isSpeaking = false;
    let speechRate = 1.0;
    let selectedVoiceIndex = 0;
    let voices = [];

    // Audio Graph
    let audioCtx, source, bassFilter, vocalFilter, compressor, analyser, canvas, ctx;
    let isAudioInit = false;
    let warpNode, warpGain, warpFilter, isWarpActive = false;

    /* --- THEMES --- */
    const THEMES = [
        { name: "SCARLET", primary: "#d32f2f", secondary: "#78909c", bg: "#0a0a0a", screen: "#000000", text: "#999" },
        { name: "DAY OPS", primary: "#c62828", secondary: "#37474f", bg: "#e0e0e0", screen: "#f5f5f5", text: "#222" },
        { name: "CRYO", primary: "#00bcd4", secondary: "#455a64", bg: "#000a12", screen: "#00101a", text: "#90a4ae" },
        { name: "NIGHT", primary: "#00e676", secondary: "#1b5e20", bg: "#000000", screen: "#050505", text: "#1b5e20" }
    ];
    let themeIndex = 0;

    /* --- INIT --- */
    window.onload = function() {
        initDB();
        loadTheme();
        setTab('logs');
        
        // Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('missionClock').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
        }, 1000);

        // Audio Events
        audio.ontimeupdate = () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if(currentIndex >= 0 && activeTab === 'logs') saveBookmark();
        };
        audio.onended = () => playNext();

        // Voice Loading
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => { voices = window.speechSynthesis.getVoices(); };
        }
        
        // Media Session
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
            navigator.mediaSession.setActionHandler('previoustrack', () => leftAction());
            navigator.mediaSession.setActionHandler('nexttrack', () => rightAction());
        }
    };

    function initDB() {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
            db = e.target.result;
            if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        };
        req.onsuccess = (e) => { db = e.target.result; scanFiles(); };
    }

    /* --- TAB LOGIC --- */
    function setTab(mode) {
        activeTab = mode;
        
        // UI Visuals
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[data-mode="${mode}"]`).classList.add('active');
        
        // View Swapping
        document.getElementById('viewAudio').style.display = (mode === 'text') ? 'none' : 'flex';
        document.getElementById('viewText').style.display = (mode === 'text') ? 'flex' : 'none';
        
        // Update Buttons
        updateLabels();
        
        // Color Shift
        let color = '#d32f2f'; // default (music / radio base)
        if (mode === 'logs') color = '#4fc3f7';
        if (mode === 'text') color = '#ffb300';
        if (mode === 'radio') color = '#ff5252';
        document.documentElement.style.setProperty('--color-primary', color);
        applyTheme(THEMES[themeIndex]); // Refresh theme with new primary
        
        if (mode === 'logs') checkBookmark();
        else document.getElementById('resumeBanner').style.display = 'none';
        
        if (mode !== 'text') scanFiles(); // Filter list
    }

    function updateLabels() {
        const t1 = document.getElementById('btnTac1');
        const t2 = document.getElementById('btnTac2');
        const t3 = document.getElementById('btnTac3');
        
        const l = document.getElementById('btnLeft');
        const c = document.getElementById('btnCenter');
        const r = document.getElementById('btnRight');
        
        const u1 = document.getElementById('btnUtil1');
        const u2 = document.getElementById('btnUtil2');

        if (activeTab === 'text') {
            t1.innerText = "---"; t2.innerText = "---"; t3.innerText = "---";
            l.innerText = "STOP"; c.innerText = "READ"; r.innerText = "PAUSE";
            u1.innerText = `SPD:${speechRate}`; u2.innerText = "VOICE";
        } else if (activeTab === 'music' || activeTab === 'radio') {
            t1.innerText = "BASS"; t2.innerText = "TREB"; t3.innerText = "LEVEL";
            l.innerText = "|<< PREV"; c.innerText = "PLAY"; r.innerText = "NEXT >>|";
            u1.innerText = audio.loop ? "LOOP:ON" : "LOOP";
            u2.innerText = isShuffle ? "SHUF:ON" : "SHUF:OFF";
        } else { // logs
            t1.innerText = "VOCAL"; t2.innerText = "CUT"; t3.innerText = "BOOST";
            l.innerText = "<< 15s"; c.innerText = "PLAY"; r.innerText = "30s >>";
            u1.innerText = `SPD:${playbackRate}`; u2.innerText = "---";
        }
    }

    /* --- SMART BUTTON ACTIONS --- */
    function tac1Action() { if(activeTab !== 'text') toggleBass(); }
    function tac2Action() { if(activeTab !== 'text') toggleVocal(); }
    function tac3Action() { if(activeTab !== 'text') toggleLeveler(); }

    function leftAction() {
        if (activeTab === 'text') {
            window.speechSynthesis.cancel();
        } else if (activeTab === 'music' || activeTab === 'radio') { 
            if(currentIndex > 0) loadTrack(currentIndex - 1); 
        } else { 
            audio.currentTime -= 15; 
        }
    }

    function centerAction() {
        if (activeTab === 'text') speakText();
        else togglePlay();
    }

    function rightAction() {
        if (activeTab === 'text') {
            window.speechSynthesis.pause();
        } else if (activeTab === 'music' || activeTab === 'radio') {
            playNext();
        } else { 
            audio.currentTime += 30; 
        }
    }

    function util1Action() {
        if (activeTab === 'text') {
            speechRate = speechRate === 1.0 ? 1.5 : (speechRate === 1.5 ? 2.0 : 1.0);
            document.getElementById('btnUtil1').innerText = `SPD:${speechRate}`;
        } else if (activeTab === 'logs' || activeTab === 'radio') {
            playbackRate = playbackRate === 1.0 ? 1.25 : (playbackRate === 1.25 ? 1.5 : 1.0);
            audio.playbackRate = playbackRate;
            document.getElementById('btnUtil1').innerText = `SPD:${playbackRate}`;
        } else { // music
            audio.loop = !audio.loop;
            document.getElementById('btnUtil1').innerText = audio.loop ? "LOOP:ON" : "LOOP";
        }
    }

    function util2Action() {
        if (activeTab === 'text') {
            if (!voices.length) return;
            selectedVoiceIndex = (selectedVoiceIndex + 1) % voices.length;
            alert("Voice: " + voices[selectedVoiceIndex].name);
        } else if (activeTab === 'music' || activeTab === 'radio') {
            isShuffle = !isShuffle;
            document.getElementById('btnUtil2').innerText = isShuffle ? "SHUF:ON" : "SHUF:OFF";
        }
    }

    function triggerLoad() {
        if (activeTab === 'text') document.getElementById('fileText').click();
        else document.getElementById('fileAudio').click();
    }

    /* --- TEXT READER ENGINE --- */
    function handleTextUpload(files) {
        const file = files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            let raw = e.target.result;
            // Scrub HTML/MD
            let clean = raw.replace(/<[^>]*>?/gm, '').replace(/[#*]/g, '');
            textContent = clean;
            document.getElementById('textOutput').innerText = clean;
        };
        reader.readAsText(file);
    }

    function speakText() {
        if (window.speechSynthesis.speaking && window.speechSynthesis.paused) {
            window.speechSynthesis.resume();
            return;
        }
        if (!textContent) return;
        
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(textContent);
        utterance.rate = speechRate;
        if (voices[selectedVoiceIndex]) utterance.voice = voices[selectedVoiceIndex];
        window.speechSynthesis.speak(utterance);
    }

    /* --- AUDIO PLAYBACK ENGINE --- */
    function togglePlay() {
        if(!isAudioInit) initAudioEngine();
        if(audio.paused) {
            if(currentIndex === -1 && playlistData.length > 0) loadTrack(0);
            else audio.play();
            document.getElementById('btnCenter').innerText = "HALT";
            document.getElementById('btnCenter').classList.add('active');
        } else {
            audio.pause();
            document.getElementById('btnCenter').innerText = activeTab === 'text' ? "READ" : "ENGAGE";
            document.getElementById('btnCenter').classList.remove('active');
        }
        updateMediaSession();
    }

    function loadTrack(index) {
        if(!isAudioInit) initAudioEngine();
        if(index < 0 || index >= playlistData.length) return;
        currentIndex = index;
        const track = playlistData[index];
        audio.src = URL.createObjectURL(track.data);
        audio.playbackRate = playbackRate;
        document.getElementById('nowPlaying').innerText = track.name;
        audio.play();
        document.getElementById('btnCenter').innerText = "HALT";
        document.getElementById('btnCenter').classList.add('active');
        renderList();
        updateMediaSession();
    }

    function playNext() {
        if (!playlistData.length) return;
        if ((activeTab === 'music' || activeTab === 'radio') && isShuffle) {
            loadTrack(Math.floor(Math.random() * playlistData.length));
        } else if (currentIndex + 1 < playlistData.length) {
            loadTrack(currentIndex + 1);
        }
    }

    /* --- AUDIO PROCESSING --- */
    function initAudioEngine() {
        if (isAudioInit) return;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            source = audioCtx.createMediaElementSource(audio);

            bassFilter = audioCtx.createBiquadFilter();
            bassFilter.type = "lowshelf"; bassFilter.frequency.value = 100;
            vocalFilter = audioCtx.createBiquadFilter();
            vocalFilter.type = "peaking"; vocalFilter.frequency.value = 3000;
            compressor = audioCtx.createDynamicsCompressor();
            analyser = audioCtx.createAnalyser();

            source.connect(bassFilter);
            bassFilter.connect(vocalFilter);
            vocalFilter.connect(compressor);
            compressor.connect(analyser);
            analyser.connect(audioCtx.destination);

            canvas = document.getElementById('visCanvas');
            ctx = canvas.getContext('2d');
            drawVis();
            isAudioInit = true;
        } catch(e) {}
    }

    function toggleBass() {
        if (!audioCtx) return;
        const btn = document.getElementById('btnTac1');
        const on = btn.classList.toggle('on');
        bassFilter.gain.setTargetAtTime(on ? 15 : 0, audioCtx.currentTime, 0.1);
    }
    function toggleVocal() {
        if (!audioCtx) return;
        const btn = document.getElementById('btnTac2');
        const on = btn.classList.toggle('on');
        vocalFilter.gain.setTargetAtTime(on ? 10 : 0, audioCtx.currentTime, 0.1);
    }
    function toggleLeveler() {
        if (!audioCtx) return;
        const btn = document.getElementById('btnTac3');
        const on = btn.classList.toggle('on');
        compressor.threshold.value = on ? -24 : 0;
        compressor.ratio.value = on ? 12 : 1;
    }

    function toggleWarp() {
        if(!isAudioInit) initAudioEngine();
        isWarpActive = !isWarpActive;
        const btn = document.getElementById('btnWarp');
        
        if (isWarpActive) {
            btn.classList.add('on');
            const bufferSize = audioCtx.sampleRate * 2; 
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

            warpNode = audioCtx.createBufferSource();
            warpNode.buffer = buffer;
            warpNode.loop = true;
            warpFilter = audioCtx.createBiquadFilter();
            warpFilter.type = 'lowpass'; warpFilter.frequency.value = 120;
            warpGain = audioCtx.createGain();
            warpGain.gain.value = 0.15;

            warpNode.connect(warpFilter);
            warpFilter.connect(warpGain);
            warpGain.connect(audioCtx.destination);
            warpNode.start();
        } else {
            btn.classList.remove('on');
            if(warpNode) warpNode.stop();
        }
    }

    function drawVis() {
        requestAnimationFrame(drawVis);
        if (!analyser || !canvas) return;

        const w = canvas.parentElement.clientWidth;
        const h = canvas.parentElement.clientHeight;
        canvas.width = w; canvas.height = h;
        
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-screen');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        const primary = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
        const active = getComputedStyle(document.documentElement).getPropertyValue('--color-active');

        const len = analyser.frequencyBinCount;
        const data = new Uint8Array(len);
        analyser.getByteFrequencyData(data);
        const barW = (w / len) * 2.5;
        let x = 0;
        for(let i=0; i<len; i++) {
            const barH = (data[i]/255) * h;
            ctx.fillStyle = barH > h*0.7 ? active : primary;
            ctx.fillRect(x, h-barH, barW-1, barH);
            x += barW;
        }
    }

    /* --- DATA & UTILS --- */
    function handleAudioUpload(files) {
        if (!db) return;
        const tx = db.transaction([STORE_NAME], 'readwrite');
        let type = 'logs';
        if (activeTab === 'music') type = 'music';
        else if (activeTab === 'radio') type = 'radio';

        Array.from(files).forEach(f => 
            tx.objectStore(STORE_NAME).add({ name: f.name, data: f, type: type })
        );
        tx.oncomplete = () => scanFiles();
    }

    function scanFiles() {
        playlistData = [];
        if (!db) return;
        const store = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME);
        store.openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const item = cursor.value;
                const itemType = item.type || 'logs'; // default to logs if old data
                
                if (activeTab === 'music' && itemType === 'music') {
                    playlistData.push({ ...item, key: cursor.key });
                } else if (activeTab === 'logs' && itemType === 'logs') {
                    playlistData.push({ ...item, key: cursor.key });
                } else if (activeTab === 'radio' && itemType === 'radio') {
                    playlistData.push({ ...item, key: cursor.key });
                }
                
                cursor.continue();
            } else {
                playlistData.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
                renderList();
            }
        };
    }

    function renderList() {
        const list = document.getElementById('playlist');
        list.innerHTML = '';
        playlistData.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = `data-row ${i === currentIndex ? 'active' : ''}`;
            div.innerHTML = `
                <span onclick="loadTrack(${i})" style="flex-grow:1; overflow:hidden; text-overflow:ellipsis;">${t.name}</span>
                <button class="btn-del" onclick="nukeOne(${t.key})">X</button>
            `;
            list.appendChild(div);
        });
    }

    function nukeOne(key) {
        if(!db) return;
        if(confirm("Purge?")) {
            db.transaction([STORE_NAME], 'readwrite')
              .objectStore(STORE_NAME)
              .delete(key).onsuccess = scanFiles;
        }
    }
    function nukeVault() {
        if(!db) return;
        if(confirm("WIPE ALL?")) {
            db.transaction([STORE_NAME], 'readwrite')
              .objectStore(STORE_NAME)
              .clear().onsuccess = () => {
                  localStorage.removeItem(BOOKMARK_KEY);
                  scanFiles();
              };
        }
    }

    function saveBookmark() {
        if (!playlistData[currentIndex]) return;
        localStorage.setItem(BOOKMARK_KEY, JSON.stringify({ name: playlistData[currentIndex].name, time: audio.currentTime }));
    }
    function checkBookmark() {
        const markRaw = localStorage.getItem(BOOKMARK_KEY);
        if (!markRaw) {
            document.getElementById('resumeBanner').style.display = 'none';
            return;
        }
        const mark = JSON.parse(markRaw);
        const banner = document.getElementById('resumeBanner');
        if (mark && playlistData.some(t => t.name === mark.name)) banner.style.display = 'block';
        else banner.style.display = 'none';
    }
    function resumePlayback() {
        const markRaw = localStorage.getItem(BOOKMARK_KEY);
        if (!markRaw) return;
        const mark = JSON.parse(markRaw);
        const idx = playlistData.findIndex(t => t.name === mark.name);
        if (idx !== -1) {
            document.getElementById('resumeBanner').style.display = 'none';
            loadTrack(idx);
            audio.onloadedmetadata = () => { audio.currentTime = mark.time; };
        }
    }

    function cycleTheme() {
        themeIndex = (themeIndex + 1) % THEMES.length;
        applyTheme(THEMES[themeIndex]);
        localStorage.setItem(THEME_KEY, themeIndex);
    }
    function loadTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved) { themeIndex = parseInt(saved); applyTheme(THEMES[themeIndex]); }
    }
    function applyTheme(t) {
        const r = document.documentElement.style;
        r.setProperty('--color-secondary', t.secondary);
        r.setProperty('--bg-armor', t.bg);
        r.setProperty('--bg-screen', t.screen);
        r.setProperty('--color-text', t.text);
    }
    function updateMediaSession() {
        if ('mediaSession' in navigator && currentIndex >= 0) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: playlistData[currentIndex].name,
                artist: "STARFARER PADD",
                album: activeTab.toUpperCase()
            });
        }
    }

</script>
</body>
</html>
